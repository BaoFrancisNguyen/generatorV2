<!-- 
Fichier: templates/index_with_map.html
Template d'int√©gration pour ajouter la cartographie OSM √† l'application existante

INSTRUCTIONS D'INSTALLATION:
1. Sauvegarder votre fichier templates/index.html actuel
2. Remplacer le contenu par ce template OU
3. Ajouter les sections n√©cessaires √† votre template existant

FICHIERS REQUIS:
- static/osm_map.js (le module de cartographie)
- static/professional_styles.css (les styles professionnels)
- Leaflet CSS/JS (charg√©s automatiquement)
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Donn√©es Malaysia - Avec Cartographie OSM</title>
    
    <!-- Styles existants (garder vos styles actuels) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- NOUVEAU: Styles professionnels -->
    <link rel="stylesheet" href="{{ url_for('static', filename='professional_styles.css') }}">
    
    <!-- NOUVEAU: Leaflet CSS (charg√© automatiquement par le module si n√©cessaire) -->
    <!-- Les biblioth√®ques sont charg√©es dynamiquement par osm_map.js -->
</head>
<body>
    <!-- Header professionnel am√©lior√© -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">üá≤üáæ</div>
                    <div class="logo-text">
                        <h1>Malaysia Data Generator</h1>
                        <p>G√©n√©rateur de donn√©es √©lectriques avec cartographie OSM</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="badge badge-success" id="systemStatus">
                        ‚úÖ Syst√®me op√©rationnel
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Section de contr√¥les principaux -->
        <div class="professional-card">
            <div class="card-header">
                <h3 class="card-title">
                    ‚öôÔ∏è Configuration de g√©n√©ration
                </h3>
                <div class="card-badge">Param√®tres</div>
            </div>

            <div class="grid grid-2">
                <!-- Param√®tres de base (garder votre logique existante) -->
                <div class="form-section">
                    <h3>üìä Param√®tres de base</h3>
                    
                    <div class="form-group">
                        <label for="numBuildings">Nombre de b√¢timents</label>
                        <input type="number" id="numBuildings" class="form-control" 
                               value="100" min="1" max="10000">
                    </div>

                    <div class="form-group">
                        <label for="startDate">Date de d√©but</label>
                        <input type="date" id="startDate" class="form-control" 
                               value="2024-01-01">
                    </div>

                    <div class="form-group">
                        <label for="endDate">Date de fin</label>
                        <input type="date" id="endDate" class="form-control" 
                               value="2024-12-31">
                    </div>

                    <div class="form-group">
                        <label for="freq">Fr√©quence des donn√©es</label>
                        <select id="freq" class="form-control">
                            <option value="H">Horaire</option>
                            <option value="D">Quotidienne</option>
                            <option value="W">Hebdomadaire</option>
                            <option value="M">Mensuelle</option>
                        </select>
                    </div>
                </div>

                <!-- Filtres g√©ographiques (garder votre logique existante) -->
                <div class="form-section">
                    <h3>üó∫Ô∏è Filtres g√©ographiques</h3>
                    
                    <div class="form-group">
                        <label for="locationMode">Mode de localisation</label>
                        <select id="locationMode" class="form-control" onchange="updateLocationFields()">
                            <option value="auto">Distribution automatique</option>
                            <option value="filter">Filtrer par crit√®res</option>
                            <option value="custom">Ville personnalis√©e</option>
                        </select>
                    </div>

                    <div id="filterFields" class="form-group" style="display: none;">
                        <label for="filterRegion">R√©gion</label>
                        <select id="filterRegion" class="form-control">
                            <option value="">Toutes les r√©gions</option>
                            <option value="Central">Central</option>
                            <option value="Northern">Northern</option>
                            <option value="Southern">Southern</option>
                            <option value="East Malaysia">East Malaysia</option>
                            <option value="East Coast">East Coast</option>
                        </select>
                    </div>

                    <div id="customFields" class="form-group" style="display: none;">
                        <label for="customCity">Nom de la ville</label>
                        <input type="text" id="customCity" class="form-control" 
                               placeholder="Ex: Kuala Lumpur">
                        
                        <label for="customPopulation" class="mt-2">Population</label>
                        <input type="number" id="customPopulation" class="form-control" 
                               placeholder="Ex: 1800000">
                    </div>

                    <!-- NOUVEAU: Bouton pour cartographie -->
                    <div class="form-group mt-3">
                        <button type="button" class="btn btn-outline w-100" 
                                onclick="showCityOnMap()">
                            üó∫Ô∏è Localiser sur la carte
                        </button>
                    </div>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex flex-center gap-2 mt-4">
                <button onclick="generateData()" class="btn btn-primary btn-lg">
                    üöÄ G√©n√©rer les donn√©es
                </button>
                <button onclick="resetForm()" class="btn btn-secondary">
                    üîÑ R√©initialiser
                </button>
                <!-- NOUVEAU: Bouton diagnostic OSM -->
                <button onclick="debugOSMMap()" class="btn btn-outline">
                    üîç Debug carte
                </button>
            </div>
        </div>

        <!-- Zone des r√©sultats -->
        <div id="results" class="fade-in" style="display: none;">
            <!-- 
            IMPORTANT: La cartographie OSM sera automatiquement ins√©r√©e ici
            par le module osm_map.js au d√©but de cette section 
            -->
            
            <!-- Alertes (garder votre logique existante) -->
            <div id="alerts"></div>

            <!-- Statistiques (am√©liorer avec les nouveaux styles) -->
            <div id="statsGrid" class="stats-container"></div>

            <!-- Pr√©visualisation des donn√©es (garder votre logique existante) -->
            <div class="professional-card">
                <div class="card-header">
                    <h3 class="card-title">
                        üìã Aper√ßu des donn√©es g√©n√©r√©es
                    </h3>
                    <div class="card-badge">R√©sultats</div>
                </div>
                <div id="dataPreview" class="data-card-body"></div>
            </div>

            <!-- Panel de validation (si disponible) -->
            <div id="validationPanel" class="professional-card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">
                        ‚úÖ Validation des donn√©es
                    </h3>
                    <div class="card-badge">Qualit√©</div>
                </div>
                <div class="data-card-body">
                    <div class="text-center">
                        <div class="stat-value" id="validationScore">0%</div>
                        <div class="stat-label">Score de qualit√©</div>
                    </div>
                    <div id="validationDetails" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Zone de chargement -->
        <div id="loadingIndicator" class="loading-container" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text">G√©n√©ration des donn√©es en cours...</div>
        </div>
    </div>

    <!-- Scripts existants (garder tous vos scripts actuels) -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    
    <!-- NOUVEAU: Script de cartographie OSM -->
    <script src="{{ url_for('static', filename='osm_map.js') }}"></script>

    <!-- NOUVEAU: Script d'int√©gration -->
    <script>
        /**
         * Script d'int√©gration pour lier l'application existante avec la cartographie OSM
         */

        // Configuration globale de l'application
        window.APP_CONFIG = {
            version: '2.0.0',
            features: {
                osm_integration: true,
                professional_design: true,
                real_time_map: true
            },
            osm: {
                enabled: true,
                auto_load: true,
                fallback_enabled: true
            }
        };

        /**
         * Fonction pour afficher une ville sur la carte
         */
        function showCityOnMap() {
            const locationMode = document.getElementById('locationMode').value;
            let cityName = '';
            
            if (locationMode === 'custom') {
                cityName = document.getElementById('customCity').value.trim();
                if (!cityName) {
                    alert('‚ö†Ô∏è Veuillez saisir un nom de ville');
                    return;
                }
            } else {
                // Utiliser une ville par d√©faut ou la premi√®re g√©n√©r√©e
                cityName = 'Kuala Lumpur';
            }
            
            // Utiliser l'API OSM Map si disponible
            if (window.OSMMapAPI && window.OSMMapAPI.isReady()) {
                window.OSMMapAPI.searchCity(cityName);
                
                // Faire d√©filer jusqu'√† la carte
                const mapContainer = document.getElementById('osmMapContainer');
                if (mapContainer) {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                console.warn('‚ö†Ô∏è Module de cartographie OSM non disponible');
                alert('üó∫Ô∏è La cartographie sera disponible apr√®s la g√©n√©ration des donn√©es');
            }
        }

        /**
         * Mise √† jour des champs de localisation
         */
        function updateLocationFields() {
            const mode = document.getElementById('locationMode').value;
            const filterFields = document.getElementById('filterFields');
            const customFields = document.getElementById('customFields');
            
            // Cacher tous les champs
            filterFields.style.display = 'none';
            customFields.style.display = 'none';
            
            // Afficher selon le mode
            if (mode === 'filter') {
                filterFields.style.display = 'block';
            } else if (mode === 'custom') {
                customFields.style.display = 'block';
            }
        }

        /**
         * R√©initialisation du formulaire
         */
        function resetForm() {
            if (confirm('üîÑ √ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) {
                document.getElementById('numBuildings').value = '100';
                document.getElementById('startDate').value = '2024-01-01';
                document.getElementById('endDate').value = '2024-12-31';
                document.getElementById('freq').value = 'H';
                document.getElementById('locationMode').value = 'auto';
                document.getElementById('customCity').value = '';
                document.getElementById('customPopulation').value = '';
                
                updateLocationFields();
                
                // Effacer la carte si elle existe
                if (window.OSMMapAPI && window.OSMMapAPI.isReady()) {
                    window.OSMMapAPI.clearBuildings();
                }
                
                // Masquer les r√©sultats
                document.getElementById('results').style.display = 'none';
            }
        }

        /**
         * Extension de la fonction generateData existante
         */
        if (typeof generateData === 'function') {
            const originalGenerateData = generateData;
            
            window.generateData = async function() {
                console.log('üöÄ G√©n√©ration avec int√©gration OSM...');
                
                try {
                    // Appeler la fonction originale
                    const result = await originalGenerateData();
                    
                    // Apr√®s g√©n√©ration r√©ussie, proposer de charger la carte
                    if (result && window.OSMMapAPI && window.OSMMapAPI.isReady()) {
                        setTimeout(() => {
                            const cityName = document.getElementById('customCity').value.trim() || 'Kuala Lumpur';
                            
                            if (confirm(`üó∫Ô∏è Voulez-vous visualiser les donn√©es sur la carte pour ${cityName} ?`)) {
                                window.OSMMapAPI.searchCity(cityName);
                                
                                // Faire d√©filer jusqu'√† la carte
                                setTimeout(() => {
                                    const mapContainer = document.getElementById('osmMapContainer');
                                    if (mapContainer) {
                                        mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    }
                                }, 1000);
                            }
                        }, 2000);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('‚ùå Erreur g√©n√©ration:', error);
                    throw error;
                }
            };
        }

        /**
         * Fonction de diagnostic OSM
         */
        function debugOSMMap() {
            if (typeof window.debugOSMMap === 'function') {
                window.debugOSMMap();
            } else {
                console.log('üîç Diagnostic OSM Map:');
                console.log('- Module OSM Map:', window.osmMap ? '‚úÖ Charg√©' : '‚ùå Non charg√©');
                console.log('- API OSM:', window.OSMMapAPI ? '‚úÖ Disponible' : '‚ùå Indisponible');
                console.log('- Leaflet:', typeof L !== 'undefined' ? '‚úÖ Charg√©' : '‚ùå Non charg√©');
                
                if (window.OSMMapAPI) {
                    console.log('- √âtat:', window.OSMMapAPI.isReady() ? '‚úÖ Pr√™t' : '‚ö†Ô∏è Pas pr√™t');
                    if (window.OSMMapAPI.isReady()) {
                        const stats = window.OSMMapAPI.getStatistics();
                        console.log('- Statistiques:', stats);
                    }
                }
            }
        }

        /**
         * Mise √† jour du statut syst√®me
         */
        function updateSystemStatus() {
            const statusElement = document.getElementById('systemStatus');
            if (!statusElement) return;
            
            let status = '‚úÖ Syst√®me op√©rationnel';
            let className = 'badge-success';
            
            // V√©rifier l'√©tat des modules
            const osmReady = window.OSMMapAPI && window.OSMMapAPI.isReady();
            const mainAppReady = typeof generateData === 'function';
            
            if (!mainAppReady) {
                status = '‚ùå Application principale non pr√™te';
                className = 'badge-error';
            } else if (!osmReady) {
                status = '‚ö†Ô∏è Cartographie en cours de chargement';
                className = 'badge-warning';
            }
            
            statusElement.textContent = status;
            statusElement.className = `badge ${className}`;
        }

        /**
         * Am√©lioration de l'affichage des statistiques
         */
        function enhanceStatsDisplay(data) {
            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid || !data) return;
            
            // Cr√©er des cartes de statistiques am√©lior√©es
            let statsHTML = '';
            
            if (data.stats) {
                const stats = data.stats;
                
                // Carte total de b√¢timents
                if (stats.buildings_count) {
                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.buildings_count.toLocaleString()}</div>
                            <div class="stat-label">B√¢timents g√©n√©r√©s</div>
                        </div>
                    `;
                }
                
                // Carte total d'enregistrements
                if (stats.total_records) {
                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_records.toLocaleString()}</div>
                            <div class="stat-label">Enregistrements totaux</div>
                        </div>
                    `;
                }
                
                // Carte villes couvertes
                if (stats.unique_locations) {
                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.unique_locations}</div>
                            <div class="stat-label">Villes</div>
                        </div>
                    `;
                }
                
                // Carte p√©riode
                if (stats.date_range) {
                    const days = Math.ceil((new Date(stats.date_range.end) - new Date(stats.date_range.start)) / (1000 * 60 * 60 * 24));
                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-value">${days}</div>
                            <div class="stat-label">Jours de donn√©es</div>
                        </div>
                    `;
                }
            }
            
            statsGrid.innerHTML = statsHTML;
            statsGrid.classList.add('fade-in');
        }

        /**
         * Am√©lioration de l'affichage des alertes
         */
        function enhanceAlertsDisplay(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            if (!alertsContainer) return;
            
            const alertTypes = {
                'success': { icon: '‚úÖ', class: 'alert-success' },
                'warning': { icon: '‚ö†Ô∏è', class: 'alert-warning' },
                'error': { icon: '‚ùå', class: 'alert-error' },
                'info': { icon: '‚ÑπÔ∏è', class: 'alert-info' }
            };
            
            const alertConfig = alertTypes[type] || alertTypes['info'];
            
            const alertHTML = `
                <div class="alert ${alertConfig.class}">
                    <div class="alert-icon">${alertConfig.icon}</div>
                    <div>${message}</div>
                </div>
            `;
            
            alertsContainer.innerHTML = alertHTML;
            alertsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        /**
         * Gestionnaire d'√©v√©nements pour l'am√©lioration de l'interface
         */
        function setupEnhancedUI() {
            // Am√©liorer les interactions des formulaires
            const formControls = document.querySelectorAll('.form-control');
            formControls.forEach(control => {
                control.addEventListener('focus', function() {
                    this.parentElement.classList.add('focused');
                });
                
                control.addEventListener('blur', function() {
                    this.parentElement.classList.remove('focused');
                });
            });
            
            // Ajouter des effets hover aux cartes
            const cards = document.querySelectorAll('.professional-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
            
            // Mise √† jour p√©riodique du statut
            setInterval(updateSystemStatus, 5000);
        }

        /**
         * Initialisation de l'interface am√©lior√©e
         */
        function initializeEnhancedInterface() {
            console.log('üé® Initialisation interface am√©lior√©e...');
            
            // Configuration de l'UI am√©lior√©e
            setupEnhancedUI();
            
            // Mise √† jour initiale du statut
            updateSystemStatus();
            
            // Exposer les fonctions d'am√©lioration globalement
            window.enhanceStatsDisplay = enhanceStatsDisplay;
            window.enhanceAlertsDisplay = enhanceAlertsDisplay;
            
            console.log('‚úÖ Interface am√©lior√©e initialis√©e');
        }

        /**
         * Gestion des erreurs globales avec interface am√©lior√©e
         */
        window.addEventListener('error', function(event) {
            console.error('üö® Erreur application:', event.error);
            enhanceAlertsDisplay(
                'Une erreur inattendue s\'est produite. Consultez la console pour plus de d√©tails.',
                'error'
            );
        });

        /**
         * D√©marrage de l'application
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM charg√© - Initialisation...');
            
            // Initialiser l'interface am√©lior√©e
            setTimeout(initializeEnhancedInterface, 100);
            
            // Initialiser les champs de localisation
            updateLocationFields();
            
            console.log('üöÄ Application avec cartographie OSM pr√™te !');
        });

        // Message de bienvenue dans la console
        console.log(`
üá≤üáæ MALAYSIA DATA GENERATOR - VERSION AVEC CARTOGRAPHIE OSM
===========================================================
‚úÖ Interface professionnelle avec glassmorphism
üó∫Ô∏è Cartographie interactive OpenStreetMap
üèóÔ∏è Visualisation des b√¢timents par type
üéØ Int√©gration compl√®te avec l'application existante
üîß Syst√®me de fallback automatique
üìä Statistiques am√©lior√©es
üé® Design responsive et moderne

Fonctionnalit√©s disponibles:
- G√©n√©ration de donn√©es avec g√©olocalisation r√©elle
- Cartographie interactive avec l√©gende
- Recherche et affichage de villes
- Export des donn√©es cartographiques
- Diagnostic et d√©bogage int√©gr√©

Pour d√©boguer: debugOSMMap()
Pour aide: Consultez la documentation du module

Pr√™t √† g√©n√©rer des donn√©es avec cartographie! üöÄ
        `);
    </script>
</body>
</html>